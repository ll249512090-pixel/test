<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­å¯»å® - æ¸¸æˆå¤§å…</title>
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; }
        #status-box { background: #f4f4f4; padding: 15px; border-radius: 8px; }
        #quest-popup {
            display: none; /* é»˜è®¤éšè— */
            background: #007aff;
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            animation: fadeIn 1s;
        }
        #quest-button {
            font-size: 1.2em;
            padding: 15px 30px;
            background: white;
            color: #007aff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <h1>æ ¡å›­å¯»å®</h1>

    <div id="status-box">
        <p><strong>çŠ¶æ€:</strong> <span id="status-message">æ­£åœ¨åˆå§‹åŒ– GPS...</span></p>
        <p><strong>æˆ‘çš„ä½ç½®:</strong> <span id="status-coords">...</span></p>
        <p><strong>è·ç¦»ç›®æ ‡:</strong> <span id="status-distance">...</span> ç±³</p>
    </div>

    <div id="quest-popup">
        <h2>ğŸ‰ æ‚¨å·²åˆ°è¾¾ç›®æ ‡åŒºåŸŸï¼</h2>
        <p>...</p>
        <button id="quest-button">å¼€å§‹æ‰«æ</button>
    </div>

    <script>
        // --- æ‚¨éœ€è¦åœ¨è¿™é‡Œé…ç½®æ‚¨çš„æ¸¸æˆ ---

        // 1. è®¾ç½®æ‚¨çš„â€œç›®æ ‡ç‚¹â€

        // (ç›®æ ‡ç‚¹ A: å›¾ä¹¦é¦†)
        // â€¼ï¸ å·²æ›´æ–°ä¸ºæ‚¨çš„çœŸå®åæ ‡å’Œæ–°åŠå¾„
        const TARGET_A_LATITUDE = 34.2195645; // æ‚¨çš„â€œå›¾ä¹¦é¦†â€çº¬åº¦
        const TARGET_A_LONGITUDE = 117.1423631; // æ‚¨çš„â€œå›¾ä¹¦é¦†â€ç»åº¦
        const TARGET_A_RADIUS = 25; // â€¼ï¸ å·²æ›´æ–°ä¸º 25 ç±³
        const TARGET_A_URL = 'scan_library.html'; 

        // (ç›®æ ‡ç‚¹ B: é’Ÿæ¥¼)
        // â€¼ï¸ æˆ‘ä¸ºæ‚¨è®¾ç½®äº†ä¸€ä¸ªè·ç¦»å›¾ä¹¦é¦†çº¦ 30-40 ç±³çš„â€œå‡â€åæ ‡ï¼Œç”¨äºæµ‹è¯•
        const TARGET_B_LATITUDE = 34.2198645; // â€¼ï¸ é’Ÿæ¥¼å‡çº¬åº¦
        const TARGET_B_LONGITUDE = 117.1426631; // â€¼ï¸ é’Ÿæ¥¼å‡ç»åº¦
        const TARGET_B_RADIUS = 15; // é’Ÿæ¥¼çš„è§¦å‘åŠå¾„
        const TARGET_B_URL = 'scan_belltower.html'; // (æ‚¨ä¹‹åéœ€è¦åˆ›å»ºè¿™ä¸ª)


        // --- ä¸‹é¢æ˜¯æ¸¸æˆé€»è¾‘ï¼Œæ‚¨ä¸éœ€è¦ä¿®æ”¹ ---

        // è·å– HTML å…ƒç´ 
        const statusMsg = document.getElementById('status-message');
        const statusCoords = document.getElementById('status-coords');
        const statusDistance = document.getElementById('status-distance');
        const questPopup = document.getElementById('quest-popup');
        const questButton = document.getElementById('quest-button');

        // å¯åŠ¨ GPS æŒç»­ç›‘è§†
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(onSuccess, onError, {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            });
        } else {
            statusMsg.innerText = "âŒ é”™è¯¯ï¼šæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ GPSã€‚";
        }

        // GPS æˆåŠŸçš„å›è°ƒ (æ¯æ¬¡ä½ç½®æ›´æ–°éƒ½ä¼šè°ƒç”¨)
        function onSuccess(position) {
            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;

            // 1. æ›´æ–° UI
            statusMsg.innerText = "GPS ä¿¡å·è‰¯å¥½ï¼Œæ­£åœ¨æ¸¸æˆä¸­...";
            statusCoords.innerText = `${userLat.toFixed(6)}, ${userLon.toFixed(6)}`;

            // 2. (å…³é”®!) æ£€æŸ¥â€œæ¸¸æˆå­˜æ¡£â€
            const libraryComplete = localStorage.getItem('library_quest_complete') === 'true';

            // 3. è®¡ç®—è·ç¦»
            const distanceToA = getDistance(userLat, userLon, TARGET_A_LATITUDE, TARGET_A_LONGITUDE);
            const distanceToB = getDistance(userLat, userLon, TARGET_B_LATITUDE, TARGET_B_LONGITUDE);

            statusDistance.innerText = `è·å›¾ä¹¦é¦†: ${distanceToA.toFixed(1)}m | è·é’Ÿæ¥¼: ${distanceToB.toFixed(1)}m`;

            // 4. (å…³é”®!) æ£€æŸ¥æ¸¸æˆé€»è¾‘ (è”åŠ¨ï¼)

            // ã€é€»è¾‘ Aã€‘: å¦‚æœâ€œæ²¡å®Œæˆâ€å›¾ä¹¦é¦†ä»»åŠ¡ï¼Œå¹¶ä¸”é è¿‘äº†å›¾ä¹¦é¦†
            if (libraryComplete === false && distanceToA < TARGET_A_RADIUS) {
                questPopup.style.display = 'block'; // æ˜¾ç¤ºå¼¹çª—
                questPopup.querySelector('h2').innerText = 'ğŸ‰ æ‚¨å·²åˆ°è¾¾å›¾ä¹¦é¦†ï¼';
                questPopup.querySelector('p').innerText = 'è¯·å¼€å§‹â€œå›¾ä¹¦é¦†çš„ç§˜å¯†â€ä¸»çº¿ä»»åŠ¡ã€‚';

                questButton.onclick = function() {
                    window.location.href = TARGET_A_URL;
                };

            // ã€é€»è¾‘ Bã€‘: å¦‚æœâ€œå·²å®Œæˆâ€å›¾ä¹¦é¦†ä»»åŠ¡ï¼Œå¹¶ä¸”é è¿‘äº†é’Ÿæ¥¼
            } else if (libraryComplete === true && distanceToB < TARGET_B_RADIUS) {
                questPopup.style.display = 'block'; // æ˜¾ç¤ºå¼¹çª—
                questPopup.querySelector('h2').innerText = 'ğŸ‰ æ‚¨å·²åˆ°è¾¾é’Ÿæ¥¼ï¼';
                questPopup.querySelector('p').innerText = 'ï¼ˆå·²è§£é”ï¼‰è¯·å¼€å§‹â€œé’Ÿæ¥¼çš„ä½è¯­â€ä¸»çº¿ä»»åŠ¡ã€‚';

                questButton.onclick = function() {
                    window.location.href = TARGET_B_URL;
                };

            // ã€é€»è¾‘ Cã€‘: ä¸åœ¨ä»»ä½•åŒºåŸŸå†…
            } else {
                questPopup.style.display = 'none'; // éšè—å¼¹çª—
            }
        }

        // GPS å¤±è´¥çš„å›è°ƒ
        function onError(error) {
            statusMsg.innerText = `âŒ GPS é”™è¯¯: ${error.message}`;
        }

        // --- (å…³é”®) è®¡ç®—ä¸¤ä¸ª GPS ç‚¹è·ç¦»çš„å‡½æ•° (Haversine å…¬å¼) ---
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // åœ°çƒåŠå¾„ (ç±³)
            const Ï†1 = lat1 * Math.PI / 180;
            const Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
            const Î”Î» = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // è¿”å›è·ç¦» (ç±³)
        }

    </script>
</body>
</html>
