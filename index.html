<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­å¯»å® - æ¸¸æˆå¤§å…</title>
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; }
        #status-box { background: #f4f4f4; padding: 15px; border-radius: 8px; }
        #quest-popup {
            display: none; /* é»˜è®¤éšè— */
            background: #007aff;
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            animation: fadeIn 1s;
        }
        #quest-button {
            font-size: 1.2em;
            padding: 15px 30px;
            background: white;
            color: #007aff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <h1>æ ¡å›­å¯»å®</h1>
    
    <div id="status-box">
        <p><strong>çŠ¶æ€:</strong> <span id="status-message">æ­£åœ¨åˆå§‹åŒ– GPS...</span></p>
        <p><strong>æˆ‘çš„ä½ç½®:</strong> <span id="status-coords">...</span></p>
        <p><strong>è·ç¦»ç›®æ ‡:</strong> <span id="status-distance">...</span> ç±³</p>
    </div>

    <div id="quest-popup">
        <h2>ğŸ‰ æ‚¨å·²åˆ°è¾¾ç›®æ ‡åŒºåŸŸï¼</h2>
        <p>è¯·å¼€å§‹â€œå›¾ä¹¦é¦†çš„ç§˜å¯†â€ä¸»çº¿ä»»åŠ¡ã€‚</p>
        <button id="quest-button">å¼€å§‹æ‰«æ</button>
    </div>

    <script>
        // --- æ‚¨éœ€è¦åœ¨è¿™é‡Œé…ç½®æ‚¨çš„æ¸¸æˆ ---

        // 1. è®¾ç½®æ‚¨çš„â€œç›®æ ‡ç‚¹â€ (æ¯”å¦‚å›¾ä¹¦é¦†)
        // (è¯·ä½¿ç”¨æ‚¨åˆšåˆšåœ¨ gpstest.html ä¸­æµ‹è¯•æˆåŠŸçš„é‚£ä¸ªåæ ‡ï¼)
        const TARGET_LATITUDE = 34.2196766; // æ›¿æ¢ä¸ºæ‚¨çš„çº¬åº¦
        const TARGET_LONGITUDE = 117.1422697; // æ›¿æ¢ä¸ºæ‚¨çš„ç»åº¦

        // 2. è®¾ç½®â€œè§¦å‘åŠå¾„â€ (å•ä½ï¼šç±³)
        const ZONE_RADIUS_METERS = 15; // 15ç±³èŒƒå›´å†…è§¦å‘

        // 3. è®¾ç½®â€œæ‰«æé¡µé¢â€çš„ç½‘å€
        // (è¿™å°±æ˜¯æˆ‘ä»¬åˆšåˆšé‡å‘½åçš„ scan_library.html)
        const TARGET_SCAN_URL = 'https://ll249512090-pixel.github.io/test/scan_library.html';

        // --- ä¸‹é¢æ˜¯æ¸¸æˆé€»è¾‘ï¼Œæ‚¨ä¸éœ€è¦ä¿®æ”¹ ---

        // è·å– HTML å…ƒç´ 
        const statusMsg = document.getElementById('status-message');
        const statusCoords = document.getElementById('status-coords');
        const statusDistance = document.getElementById('status-distance');
        const questPopup = document.getElementById('quest-popup');
        const questButton = document.getElementById('quest-button');

        // ç»‘å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        questButton.onclick = function() {
            statusMsg.innerText = "æ­£åœ¨è·³è½¬åˆ° AR æ‰«ææ¨¡å—...";
            window.location.href = TARGET_SCAN_URL; // è·³è½¬é¡µé¢
        };

        // å¯åŠ¨ GPS æŒç»­ç›‘è§†
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(onSuccess, onError, {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            });
        } else {
            statusMsg.innerText = "âŒ é”™è¯¯ï¼šæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ GPSã€‚";
        }

        // GPS æˆåŠŸçš„å›è°ƒ (æ¯æ¬¡ä½ç½®æ›´æ–°éƒ½ä¼šè°ƒç”¨)
        function onSuccess(position) {
            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;

            // 1. æ›´æ–° UI
            statusMsg.innerText = "GPS ä¿¡å·è‰¯å¥½ï¼Œæ­£åœ¨æ¸¸æˆä¸­...";
            statusCoords.innerText = `${userLat.toFixed(6)}, ${userLon.toFixed(6)}`;
            
            // 2. è®¡ç®—è·ç¦»
            const distance = getDistance(userLat, userLon, TARGET_LATITUDE, TARGET_LONGITUDE);
            statusDistance.innerText = distance.toFixed(1);

            // 3. æ£€æŸ¥æ˜¯å¦è¿›å…¥åŒºåŸŸ
            if (distance < ZONE_RADIUS_METERS) {
                questPopup.style.display = 'block'; // æ˜¾ç¤ºå¼¹çª—
            } else {
                questPopup.style.display = 'none'; // éšè—å¼¹çª—
            }
        }

        // GPS å¤±è´¥çš„å›è°ƒ
        function onError(error) {
            statusMsg.innerText = `âŒ GPS é”™è¯¯: ${error.message}`;
        }

        // --- (å…³é”®) è®¡ç®—ä¸¤ä¸ª GPS ç‚¹è·ç¦»çš„å‡½æ•° (Haversine å…¬å¼) ---
        // (æ‚¨ä¸éœ€è¦æ‡‚ï¼Œåªéœ€è¦çŸ¥é“å®ƒèƒ½ç”¨)
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // åœ°çƒåŠå¾„ (ç±³)
            const Ï†1 = lat1 * Math.PI / 180;
            const Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
            const Î”Î» = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // è¿”å›è·ç¦» (ç±³)
        }

    </script>
</body>
</html>
